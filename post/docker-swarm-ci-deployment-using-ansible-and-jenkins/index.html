<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="/images/favicon.svg">
    
    <link rel="stylesheet" href="/scss/global.min.7c834613444ba8289e55db2f7f35892dcda2bf80c7fd9532773de87cf80ecbbe.css">
    
    <link rel="stylesheet" media="print" href="/scss/print.min.193f43bff9320cd288969561890c18538b569964654e395f5049c5975c65021f.css">

    
    <link rel="stylesheet" href="/css/prism.css" />
    <link href="https://fonts.googleapis.com/css?family=Merriweather&display=swap" rel="stylesheet">
    

 






	




<title>Docker Swarm CI deployment using Ansible and Jenkins | Adrian Gheorghe</title>
<meta name="description" content="Docker Swarm CI deployment using Ansible and Jenkins Published on Medium
This article is PART 3 of a series on Dockerizing your own personal infrastructure (Docker Swarm, RexRay, Traefik, Let’s Encrypt, DigitalOcean, Jenkins, Ansible)
PART 1 and PART 2
In order to set up a continuous integration workflow for Docker Swarm mode you can use an array of tools. For the purpose of this article and for my personal stack i have used Jenkins and Ansible.">
<meta property="og:title" content="Docker Swarm CI deployment using Ansible and Jenkins | Adrian Gheorghe">
<meta property="og:site_name" content="Adrian Gheorghe">
<meta property="og:description" content="Docker Swarm CI deployment using Ansible and Jenkins Published on Medium
This article is PART 3 of a series on Dockerizing your own personal infrastructure (Docker Swarm, RexRay, Traefik, Let’s Encrypt, DigitalOcean, Jenkins, Ansible)
PART 1 and PART 2
In order to set up a continuous integration workflow for Docker Swarm mode you can use an array of tools. For the purpose of this article and for my personal stack i have used Jenkins and Ansible.">
<meta property="og:url" content="https://www.adigheorghe.ro/post/docker-swarm-ci-deployment-using-ansible-and-jenkins/">
<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:image" content='https://www.adigheorghe.ro/images/hero-3.jpg'><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Docker Swarm CI deployment using Ansible and Jenkins | Adrian Gheorghe">

	<link rel="canonical" href="https://www.adigheorghe.ro/post/docker-swarm-ci-deployment-using-ansible-and-jenkins/">


	<meta name="twitter:site" content="@https://twitter.com/adi_ghe">
	<meta name="twitter:creator" content="@https://twitter.com/adi_ghe">

	<meta name="twitter:description" content="Docker Swarm CI deployment using Ansible and Jenkins Published on Medium
This article is PART 3 of a series on Dockerizing your own personal infrastructure (Docker Swarm, RexRay, Traefik, Let’s Encrypt, DigitalOcean, Jenkins, Ansible)
PART 1 and PART 2
In order to set up a continuous integration workflow for Docker Swarm mode you can use an array of tools. For the purpose of this article and for my personal stack i have used Jenkins and Ansible.">
<meta name="twitter:image" content="https://www.adigheorghe.ro/images/hero-3.jpg">
<meta property="article:published_time" content="2019-03-05T00:00:00&#43;00:00">
	<meta property="article:updated_time" content="2019-03-05T00:00:00&#43;00:00">



    </head>


<body class="line-numbers">

    
    <script src="/js/initColors.js"></script>

    <div class="layout-styled">

        <Section class="section">
    <div class="nav-container">
        <a class="logo-link" href="/">
            <div id="logo-desktop">
    <i class="fas fa-at"></i>
    <svg width="192" viewBox="0 0 304 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
        <g transform="matrix(1,0,0,1,-273.769,-89.0174)">
            <g>
                <text class="change-fill" x="272.622px" y="126.713px" style="font-family:'Righteous-Regular', 'Righteous';font-size:50px;">adi</text>
                <text x="359.145px" y="126.713px" style="font-family:'Righteous-Regular', 'Righteous';font-size:50px;fill:rgb(89,89,89);">ghe<tspan x="443.691px 472.646px 492.861px 523.256px " y="126.713px 126.713px 126.713px 126.713px ">orgh</tspan>e</text>
            </g>
        </g>
        <defs>
            <clipPath id="clip0">
                <rect width="191.156" height="23" fill="white" />
            </clipPath>
        </defs>
    </svg>
</div>
<div id="logo-mobile" class="hidden">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
         width="23" height="23" viewBox="0 0 512.000000 512.000000"
         preserveAspectRatio="xMidYMid meet">
        <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"
           fill="" stroke="none">
            <path d="M590 4383 l1 -738 756 -530 c698 -489 1151 -807 2618 -1837 l540
   -380 3 748 c2 590 -1 751 -10 760 -7 7 -308 218 -668 470 -360 251 -1230 859
   -1933 1351 -702 491 -1284 893 -1292 893 -13 0 -15 -92 -15 -737z"/>
            <path d="M3887 4708 l-597 -412 0 -381 0 -381 597 -419 c328 -231 602 -421
   610 -423 11 -3 13 204 13 1212 0 987 -2 1216 -13 1216 -7 0 -282 -186 -610
   -412z"/>
            <path d="M590 2135 c0 -910 3 -1225 11 -1225 10 0 343 231 1049 728 l155 109
   0 389 0 388 -595 418 c-327 229 -601 417 -607 418 -10 0 -13 -251 -13 -1225z"/>
            <path d="M590 320 l0 -310 1960 0 1960 0 0 310 0 310 -1960 0 -1960 0 0 -310z"/>
        </g>
    </svg>
</div>
            <span class="header-hidden">Navigate back to the homepage</span>
        </a>
        <div class="nav-controls">
            <a class="resume" href="/resume">
                <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     width="25px" height="30px" viewBox="0 0 45.057 45.057" style="enable-background:new 0 0 25 25;"
                     xml:space="preserve">
                    <g>
                        <g id="_x35_8_24_">
                            <g>
                                <path style="fill:#73737D;" d="M19.558,25.389c-0.067,0.176-0.155,0.328-0.264,0.455c-0.108,0.129-0.24,0.229-0.396,0.301
                                    c-0.156,0.072-0.347,0.107-0.57,0.107c-0.313,0-0.572-0.068-0.78-0.203c-0.208-0.137-0.374-0.316-0.498-0.541
                                    c-0.124-0.223-0.214-0.477-0.27-0.756c-0.057-0.279-0.084-0.564-0.084-0.852c0-0.289,0.027-0.572,0.084-0.853
                                    c0.056-0.281,0.146-0.533,0.27-0.756c0.124-0.225,0.29-0.404,0.498-0.541c0.208-0.137,0.468-0.203,0.78-0.203
                                    c0.271,0,0.494,0.051,0.666,0.154c0.172,0.105,0.31,0.225,0.414,0.361c0.104,0.137,0.176,0.273,0.216,0.414
                                    c0.04,0.139,0.068,0.25,0.084,0.33h2.568c-0.112-1.08-0.49-1.914-1.135-2.502c-0.644-0.588-1.558-0.887-2.741-0.895
                                    c-0.664,0-1.263,0.107-1.794,0.324c-0.532,0.215-0.988,0.52-1.368,0.912c-0.38,0.392-0.672,0.863-0.876,1.416
                                    c-0.204,0.551-0.307,1.165-0.307,1.836c0,0.631,0.097,1.223,0.288,1.77c0.192,0.549,0.475,1.021,0.847,1.422
                                    s0.825,0.717,1.361,0.949c0.536,0.23,1.152,0.348,1.849,0.348c0.624,0,1.18-0.105,1.668-0.312
                                    c0.487-0.209,0.897-0.482,1.229-0.822s0.584-0.723,0.756-1.146c0.172-0.422,0.259-0.852,0.259-1.283h-2.593
                                    C19.68,25.023,19.627,25.214,19.558,25.389z"/>
                                <polygon style="fill:#73737D;" points="26.62,24.812 26.596,24.812 25.192,19.616 22.528,19.616 25.084,28.184 28.036,28.184 30.713,19.616 28,19.616
                                                "/>
                                <path style="fill:#73737D;" d="M33.431,0H5.179v45.057h34.699V6.251L33.431,0z M36.878,42.056H8.179V3h23.706v4.76h4.992L36.878,42.056L36.878,42.056z"
                                />
                            </g>
                        </g>
                    </g>
                </svg>
            </a>
            <button id="copyButton" class="icon-wrapper">
                <svg
    class="icon-image"
    width="24"
    height="20"
    viewBox="0 0 24 20"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
    >
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M2 5C2 3.34328 3.34328 2 5 2H14C15.6567 2 17 3.34328 17 5V9C17 10.6567 15.6567 12 14 12H10C9.44771 12 9 12.4477 9 13C9 13.5523 9.44771 14 10 14H14C16.7613 14 19 11.7613 19 9V5C19 2.23872 16.7613 0 14 0H5C2.23872 0 0 2.23872 0 5V9C0 10.4938 0.656313 11.8361 1.6935 12.7509C2.10768 13.1163 2.73961 13.0767 3.10494 12.6625C3.47028 12.2483 3.43068 11.6164 3.0165 11.2511C2.39169 10.6999 2 9.89621 2 9V5ZM7 11C7 9.34328 8.34328 8 10 8H14C14.5523 8 15 7.55228 15 7C15 6.44772 14.5523 6 14 6H10C7.23872 6 5 8.23872 5 11V15C5 17.7613 7.23872 20 10 20H19C21.7613 20 24 17.7613 24 15V11C24 9.50621 23.3437 8.16393 22.3065 7.24906C21.8923 6.88372 21.2604 6.92332 20.8951 7.3375C20.5297 7.75168 20.5693 8.38361 20.9835 8.74894C21.6083 9.30007 22 10.1038 22 11V15C22 16.6567 20.6567 18 19 18H10C8.34328 18 7 16.6567 7 15V11Z"
      fill="#000"
    />
</svg>
                <div id="toolTip" class="tool-tip " >
                    copied
                </div>
                <input id="copyText" style="opacity: 0;" type="text" class="tool-tip " />
            </button>

            <button id="themeColorButton" class="icon-wrapper">
                <div id="sunRays" class="sun-rays"></div>
                <div id="moonOrSun" class="moon-or-sun"></div>
                <div id="moonMask" class="moon-mask"></div>
            </button>
        </div>
    </div>
</Section>


<script src="/js/toggleLogos.js"></script>


<script src="/js/toggleColors.js"></script>


<script src="/js/copyUrl.js"></script>

        

<section class="section narrow">

    <section id="articleHero" class="section narrow">
    <div class="article-hero">
        <header class="article-header">
            <h1 class="article-hero-heading">Docker Swarm CI deployment using Ansible and Jenkins</h1>
            <div class="article-hero-subtitle">
                <div class="article-meta">
                    


    
            <a href="/authors/adrian-gheorghe/" class="article-author-link">
                
                    <div class="article-author-avatar">
                        <img src="/profile-img.jpg" />
                    </div>
                
                
                <strong>Adrian Gheorghe</strong>
                
                <span class="hide-on-mobile">,&nbsp;</span>
            </a>
    



<script src="/js/collapseAuthors.js"></script>
                    March 5, 2019
                     • 8 min read
                </div>
            </div>
        </header>
        
        <div class="article-hero-image" id="ArticleImage__Hero">
            <img src="/images/hero-3.jpg">
        </div>
        
    </div>
</section>

    <aside id="progressBar" class="aside-container">
    <div class="aside-align">
      <div>
        <div class="overlap-container">
        </div>
      </div>
    </div>
    
    <div class="progress-container" tabIndex={-1}>
        <div class="track-line" aria-hidden="true">
            <div id="progressIndicator" class="progress-line"></div>
        </div>
    </div>
</aside>

    <article  id="articleContent" class="post-content">
        <h1 id="docker-swarm-ci-deployment-using-ansible-and-jenkins"><strong>Docker Swarm CI deployment using Ansible and Jenkins</strong></h1>
<p><a href="https://medium.com/@adrian.gheorghe.dev/docker-swarm-ci-deployment-using-ansible-and-jenkins-ddfc99296db8">Published on Medium</a></p>
<p>This article is PART 3 of a series on <strong>Dockerizing your own personal infrastructure (Docker Swarm, RexRay, Traefik, Let’s Encrypt, DigitalOcean, Jenkins, Ansible)</strong></p>
<p><a href="https://medium.com/@adrian.gheorghe.dev/dockerizing-your-own-personal-infrastructure-docker-swarm-rexray-traefik-lets-encrypt-7b3b29b12ad0">PART 1</a> and <a href="https://medium.com/@adrian.gheorghe.dev/docker-swarm-volume-data-persistence-on-digital-ocean-with-rexray-cd418f718131">PART 2</a></p>
<p>In order to set up a continuous integration workflow for Docker Swarm mode you can use an array of tools. For the purpose of this article and for my personal stack i have used Jenkins and Ansible. They are both open source tools with very large communities.</p>
<p>Let’s assume you want to deploy a single page application developed using React to your Docker Swarm using Jenkins and Ansible. You will need to set up a git repository that contains your application code. Some additional files will need to be added to the repo for this set up, but more on each below.</p>
<p>Jenkinsfile / Dockerfile / docker-compose.yml / devops directory</p>
<h3 id="jenkins">Jenkins</h3>
<blockquote>
<p><em>Jenkins</em> is an open source automation server written in Java which allows you to automate your build process.</p>
</blockquote>
<p>I have written about Jenkins before and how you can implement <a href="https://medium.com/@adrian.gheorghe.dev/using-jenkins-pipelines-b2cf684d42fb">Jenkins pipelines to set up your continuous integration workflow</a>. Assuming you already have a Jenkins server set up, what you need to do first of all is add a Jenkinsfile to your application repository. Afterwards, you will need to set up a new Jenkins pipeline / multibranch pipeline project on your Jenkins install having the application repository as a scm source.</p>
<p>This will allow Jenkins to do multiple things. First off it will use your repository code as a build starting point. Checking out on the latest commit of your specified branch. Secondly, it will parse your <strong>Jenkinsfile</strong> and will execute all the steps provided by it. What the <strong>Jenkinsfile</strong> contains is up to you. Using Groovy syntax you can add stages and steps to your deployment process.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">pipeline <span style="color:#f92672">{</span>  
  agent any  
  
  
  environment <span style="color:#f92672">{</span>  
    PROJECT_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;myproject&#39;</span>  
    DOMAIN<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">’</span>mydomain<span style="color:#f92672">.</span><span style="color:#a6e22e">com</span><span style="color:#e6db74">&#39;  
</span><span style="color:#e6db74">    STACK=’mystack&#39;</span>  
    DOCKER_REGISTRY<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">’</span>https:<span style="color:#75715e">//my.docker.registry&#39;  
</span><span style="color:#75715e"></span>    CONTAINER<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">’</span>vendor<span style="color:#e6db74">/app&#39;  
</span><span style="color:#e6db74">    VERSION=&#34;1.${BUILD_NUMBER}&#34;  
</span><span style="color:#e6db74">  }  
</span><span style="color:#e6db74">  stages {  
</span><span style="color:#e6db74">    stage(’Tag Git Commit’) {  
</span><span style="color:#e6db74">      steps {  
</span><span style="color:#e6db74">        sshagent ([’jenkins’\]) {  
</span><span style="color:#e6db74">            script {  
</span><span style="color:#e6db74">                sh &#39;’&#39;  
</span><span style="color:#e6db74">                    git tag -a &#34;v${VERSION}&#34; -m &#34;Jenkins&#34;  
</span><span style="color:#e6db74">                    git push origin &#34;v${VERSION}&#34; -vvv  
</span><span style="color:#e6db74">                &#39;’&#39;  
</span><span style="color:#e6db74">            }  
</span><span style="color:#e6db74">        }  
</span><span style="color:#e6db74">      }  
</span><span style="color:#e6db74">    }  
</span><span style="color:#e6db74">    stage(’Build Image’) {  
</span><span style="color:#e6db74">      steps {  
</span><span style="color:#e6db74">        script {  
</span><span style="color:#e6db74">            docker.withRegistry(&#34;${DOCKER_REGISTRY}&#34;, &#39;docker-registry-credentials’) {  
</span><span style="color:#e6db74">                def img = docker.build(&#34;${CONTAINER}:${VERSION}&#34;)  
</span><span style="color:#e6db74">                img.push()  
</span><span style="color:#e6db74">                sh &#34;docker rmi ${img.id}&#34;  
</span><span style="color:#e6db74">            }  
</span><span style="color:#e6db74">        }  
</span><span style="color:#e6db74">      }  
</span><span style="color:#e6db74">    }  
</span><span style="color:#e6db74">    stage(’Deploy Stack’) {  
</span><span style="color:#e6db74">      steps {  
</span><span style="color:#e6db74">          withCredentials([  
</span><span style="color:#e6db74">              usernamePassword(  
</span><span style="color:#e6db74">                  credentialsId: &#39;docker-registry-credentials’,  
</span><span style="color:#e6db74">                  usernameVariable: &#39;DOCKER_USER’,  
</span><span style="color:#e6db74">                  passwordVariable: &#39;DOCKER_PASSWORD&#39;  
</span><span style="color:#e6db74">              )  
</span><span style="color:#e6db74">          \])  
</span><span style="color:#e6db74">          {  
</span><span style="color:#e6db74">            script {  
</span><span style="color:#e6db74">                echo &#34;Deploying Container Stack to Docker Cluster&#34;  
</span><span style="color:#e6db74">                sh &#34;ansible-playbook -i devops/</span>inventories<span style="color:#e6db74">/manager1/</span>hosts devops<span style="color:#f92672">/</span>manager1<span style="color:#f92672">.</span><span style="color:#a6e22e">yml</span> <span style="color:#f92672">-</span><span style="color:#f92672">-</span>extra<span style="color:#f92672">-</span>vars<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#e6db74">&#34;{’WORKSPACE’: &#39;${env.WORKSPACE}’, &#39;DOMAIN’: &#39;${env.DOMAIN}’, &#39;PROJECT’: &#39;${env.PROJECT}’, &#39;STACK’: &#39;${env.STACK}’, &#39;VERSION’: &#39;${env.VERSION}’, &#39;DOCKER_REGISTRY’: &#39;${env.DOCKER_REGISTRY}’, &#39;DOCKER_USER’: &#39;${env.DOCKER_USER}’, &#39;DOCKER_PASSWORD’: &#39;${env.DOCKER_PASSWORD}’}\\&#34;</span> <span style="color:#f92672">-</span>vvv<span style="color:#960050;background-color:#1e0010">&#34;</span>  
            <span style="color:#f92672">}</span>  
          <span style="color:#f92672">}</span>  
      <span style="color:#f92672">}</span>  
    <span style="color:#f92672">}</span>  
  <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span>
</code></pre></div><p>Reading through the <strong>Jenkinsfile</strong> pipeline, we see that the first stage adds a git tag with the Build Number to the repository. This step is not necessary, but i find it better to have a build reference stored as a tag in the git repo as well. This makes for an easier understanding of each release.</p>
<p>The following stage will build and push the Docker image for our react app.</p>
<blockquote>
<p>Store your docker registry credentials in Jenkins. They will need to be referenced when pushing / pulling your container images.</p>
</blockquote>
<p>Our repository should contain the <strong>Dockerfile</strong> for the application Docker image we will be building.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#75715e"># base image  </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> node as builder  </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># set working directory  </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir /usr/src/app  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /usr/src/app  </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># install and cache app dependencies  </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> package.json /usr/src/app/package.json  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> npm install --silent  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> npm install react-scripts@1.1.1 -g --silent  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . /usr/src/app  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> npm run build  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">## production environment</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> nginx  </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /**usr**/**src**/**app**/**build **/**usr**/**share**/**nginx**/**html  <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 80  </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;nginx&#34;</span>, <span style="color:#e6db74">&#34;-g&#34;</span>, <span style="color:#e6db74">&#34;daemon off;&#34;</span><span style="color:#960050;background-color:#1e0010">\</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>This <strong>Dockerfile</strong> uses a <strong>Node</strong> base image in order to be able to run <strong>npm run build</strong> and then switches to an <strong>Nginx</strong> image having the application code directly embedded in the image. This is of course an example, this should contain whatever suits your needs for your container.</p>
<p>The next step in the Jenkinsfile builds the new version of the image and pushes it to whatever docker registry you are using, passing in the registry credentials stored in Jenkins. Afterwards the local image is removed to save storage space.</p>
<p>Alongside your Dockerfile, you will need to set up the container stack using a <strong>docker-compose.yml</strong> file. In our case the stack will only contain one service. The nginx web server we have just build.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">version: <span style="color:#e6db74">&#39;3.3&#39;</span>  
  
networks:  
  traefik-net:  
    external: <span style="color:#66d9ef">true</span>  
services:  
  web:  
    image: my.docker.registry/vendor/app:IMAGEVERSION  
    deploy:  
      placement:  
        constraints: 
          - node.role == worker  
      restart_policy:  
        condition: on-failure  
      labels: 
        - <span style="color:#e6db74">&#34;traefik.enable=true&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.basic.port=80&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.basic.protocol=http&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.backend=mydomain&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.frontend.rule=Host:mydomain.com&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.docker.network=traefik-net&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.backend.loadbalancer.swarm=true&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.frontend.headers.SSLRedirect=true&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.frontend.headers.SSLHost=mydomain.com&#34;</span>  
        - <span style="color:#e6db74">&#34;traefik.frontend.headers.SSLForceHost=true&#34;</span>  
    networks: 
- traefik-net
</code></pre></div><p>The service is set up to only reside on a worker node and not on a manager, will restart on failure and has the labels required by Traefik to correctly redirect requests to mydomain.com to your container on the correct port. You will of course need to point mydomain.com to your Docker Swarm manager.</p>
<p>Moving on in the Jenkinsfile to the next stage of the pipeline, where the stack is actually deployed to your docker swarm manager. We then run the ansible playbook using the parameters we need as extra arguments.</p>
<p>The Ansible playbook resides in the devops directory, but it can be placed anywhere you require.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">--<span style="color:#e6db74">-  </span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">- hosts: manager1  </span>
  become: <span style="color:#66d9ef">true</span>  
  any_errors_fatal: <span style="color:#66d9ef">true</span>  
  
  tasks: 
    - name: Create project directory  
      file: path=/opt/{{ PROJECT }}/{{ DOMAIN }} state=directory  
      tags: docker-swarm-deploy  
  
    - name: Copy Docker Stack File  
      copy:  
        src: ../docker-compose.yml  
        dest: /opt/{{ PROJECT }}/{{ DOMAIN }}/docker-compose.yml  
        owner: <span style="color:#e6db74">&#34;root&#34;</span>  
        group: <span style="color:#e6db74">&#34;root&#34;</span>  
        mode: u=rw,g=r,o=r  
      tags: docker-swarm-deploy  
  
    - name: Replace Placeholders Version  
      shell: <span style="color:#e6db74">&gt;  
</span><span style="color:#e6db74">       </span><span style="color:#e6db74"> </span><span style="color:#e6db74">sed -i -e &#39;s/IMAGEVERSION/{{ VERSION }}/g&#39; docker-swarm.yml  </span>
      args:  
        chdir: <span style="color:#e6db74">&#34;/opt/{{ PROJECT }}/{{ DOMAIN }}/&#34;</span>  
      become: <span style="color:#66d9ef">true</span>  
      become_user: root  
      tags: docker-swarm-deploy  
  
    - name: Login to registry  
      shell: <span style="color:#e6db74">&gt;  
</span><span style="color:#e6db74">       </span><span style="color:#e6db74"> </span><span style="color:#e6db74">docker login -u {{ DOCKER_USER }} -p {{ DOCKER_PASSWORD }} {{ DOCKER_REGISTRY }}  </span>
      become: <span style="color:#66d9ef">true</span>  
      become_user: root  
      tags: docker-swarm-deploy  
  
    - name: Deploy Docker Stack  
      shell: <span style="color:#e6db74">&gt;  
</span><span style="color:#e6db74">       </span><span style="color:#e6db74"> </span><span style="color:#e6db74">docker stack deploy -c /opt/{{ PROJECT }}/{{ DOMAIN }}/docker-compose.yml {{ STACK }} --with-registry-auth  </span>
      become: <span style="color:#66d9ef">true</span>  
      become_user: root  
      tags: docker-swarm-deploy
</code></pre></div><p>Alongside the playbook we have a hosts file as well. The hosts file contains the docker swarm manager host or ip that ansible should connect to.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">[manager1] 
<span style="color:#ae81ff">11.11</span><span style="color:#ae81ff">.11</span><span style="color:#ae81ff">.11</span>  
  
[manager1:vars] 
ansible_ssh_user=root  
ansible_ssh_private_key_file=/jenkins/path/to/private/key
</code></pre></div><p>The playbook contains tasks that Ansible needs to run on the Docker manager in order to deploy your stack to the swarm. That means copying the docker-compose file to a specific location, replacing the image tag placeholder with the new version so we get new containers with the new code.</p>
<p>The next task is making sure we are logged into the docker registry we are using to store the image so we don’t get an unauthorized error.</p>
<p>Finally the last task deploys the stack in the docker-compose.yml to your docker swarm manager. The manager handles the rest and creates new services for <strong>mydomain.com.</strong> Traefik listens in on the services created and will now redirect all requests to mydomain.com to your stack, also generating a Let’s Encrypt certificate in the process.</p>
<p>So after adding all this to your application repository, and the task in Jenkins, you will be able to run a build that deploys your containerized application to your Docker Swarm.</p>

    </article>

    
    





    
    
    
        
    




<section id="articleNext" class="section nartrow">
    <h3 class="footer-next-heading">More articles from Adrian Gheorghe</h3>
    <div class="footer-spacer"></div>
    <div class="next-articles-grid" numberOfArticles={numberOfArticles}>
        <div class="post-row">
            
                <a href="/post/moni-easily-monitor-directory-structure-and-content-changes/" class="article-link"
                 id="article-link-bigger">
                    <div>
                        <div class="image-container">
                            <img src="/img/1__15Ck9QYmcclxb__ofhM__AaA.jpeg" class="article-image" /> 
                        </div>
                        <div>
                            <h2 class="article-title">
                                moni — easily monitor directory structure and content changes
                            </h2>
                            <p class="article-excerpt">
                                moni — short for monitoring (thank you Captain Obvious) — is a small utility I have written in go. Its main purpose is to walk through a…
                            </p>
                            <div class="article-metadata">
                                February 2, 2019 · 5 min read
                            </div>
                        </div>
                    </div>
                </a>
            
                <a href="/post/wait-sh-wait-for-hosts-to-be-accessible-or-a-command-to-return-true/" class="article-link"
                >
                    <div>
                        <div class="image-container">
                            <img src="/img/railroad-tracks-in-city-against-sky-258458.jpg" class="article-image" /> 
                        </div>
                        <div>
                            <h2 class="article-title">
                                Wait.sh — wait for hosts to be accessible or a command to return true
                            </h2>
                            <p class="article-excerpt">
                                wait.sh is a bash script I wrote to help me set up my docker powered projects and allow me to have a functioning build process for database…
                            </p>
                            <div class="article-metadata">
                                September 9, 2018
                            </div>
                        </div>
                    </div>
                </a>
            
        </div>
    </div>
</section>

</section>


 <script src="/js/progressBar.js"></script>

        
        <div class="footer-gradient"></div>
    <div class="section narrow">
      <div class="footer-hr"></div>
      <div class="footer-container">
        <div class="footer-text">
          © 2020 Adrian Gheorghe
        </div>
        <div class="social-icon-outer">
    <div class="social-icon-container">
        
            
                
                <a href="https://www.facebook.com/adrian.gheorghe.7"><svg
class="social-icon-image"
width="7"
height="14"
viewBox="0 0 7 14"
fill="none"
xmlns="http://www.w3.org/2000/svg"
>
<path
  fillRule="evenodd"
  clipRule="evenodd"
  d="M4.36849 7.36482H6.35279L6.64986 4.99457H4.36849V3.48124C4.36849 2.79501 4.55373 2.32731 5.5103 2.32731L6.73028 2.32673V0.206821C6.51919 0.17804 5.79505 0.113525 4.95257 0.113525C3.19363 0.113525 1.98943 1.21807 1.98943 3.24662V4.99464H0V7.36488H1.98936V13.4469L4.36849 13.4468V7.36482Z"
  fill="#73737D"
/>
</svg></a>
                <span class="hidden">https://www.facebook.com/adrian.gheorghe.7</span>
            
        
            
                
                <a href="https://github.com/adrian-gheorghe"><svg
class="social-icon-image"
width="14"
height="14"
viewBox="0 0 14 14"
fill="none"
xmlns="http://www.w3.org/2000/svg"
>
<path
  fillRule="evenodd"
  clipRule="evenodd"
  d="M7 0C3.1325 0 0 3.21173 0 7.17706C0 10.3529 2.00375 13.0353 4.78625 13.9863C5.13625 14.0491 5.2675 13.8338 5.2675 13.6454C5.2675 13.4749 5.25875 12.9097 5.25875 12.3087C3.5 12.6406 3.045 11.8691 2.905 11.4653C2.82625 11.259 2.485 10.622 2.1875 10.4516C1.9425 10.317 1.5925 9.98508 2.17875 9.97611C2.73 9.96714 3.12375 10.4964 3.255 10.7118C3.885 11.7973 4.89125 11.4923 5.29375 11.3039C5.355 10.8374 5.53875 10.5234 5.74 10.3439C4.1825 10.1645 2.555 9.54549 2.555 6.80026C2.555 6.01976 2.82625 5.37382 3.2725 4.87143C3.2025 4.692 2.9575 3.95635 3.3425 2.96951C3.3425 2.96951 3.92875 2.78111 5.2675 3.70516C5.8275 3.54367 6.4225 3.46293 7.0175 3.46293C7.6125 3.46293 8.2075 3.54367 8.7675 3.70516C10.1063 2.77214 10.6925 2.96951 10.6925 2.96951C11.0775 3.95635 10.8325 4.692 10.7625 4.87143C11.2087 5.37382 11.48 6.01079 11.48 6.80026C11.48 9.55446 9.84375 10.1645 8.28625 10.3439C8.54 10.5682 8.75875 10.9988 8.75875 11.6717C8.75875 12.6316 8.75 13.4032 8.75 13.6454C8.75 13.8338 8.88125 14.0581 9.23125 13.9863C11.9963 13.0353 14 10.3439 14 7.17706C14 3.21173 10.8675 0 7 0Z"
  fill="#73737D"
/>
</svg></a>
                <span class="hidden">https://github.com/adrian-gheorghe</span>
            
        
            
                
                <a href="https://www.linkedin.com/in/adrian-gheorghe-01836344/"><svg
class="social-icon-image"
width="14"
height="14"
viewBox="0 0 14 14"
fill="none"
xmlns="http://www.w3.org/2000/svg"
{...props}
>
<path
  fillRule="evenodd"
  clipRule="evenodd"
  d="M3.59615 13.125H0.871552V4.36523H3.59615V13.125ZM2.24847 3.16406C1.81878 3.16406 1.44769 3.00781 1.13519 2.69531C0.822692 2.38281 0.666443 2.01171 0.666443 1.58203C0.666443 1.15234 0.822692 0.781248 1.13519 0.468749C1.44769 0.156249 1.81878 0 2.24847 0C2.67816 0 3.04925 0.156249 3.36175 0.468749C3.67425 0.781248 3.8305 1.15234 3.8305 1.58203C3.8305 2.01171 3.67425 2.38281 3.36175 2.69531C3.04925 3.00781 2.67816 3.16406 2.24847 3.16406ZM13.7915 13.125H11.0669V8.84765C11.0669 8.14452 11.0083 7.63671 10.8911 7.32421C10.6763 6.79687 10.2563 6.5332 9.63134 6.5332C9.00634 6.5332 8.56689 6.76757 8.31298 7.23632C8.11767 7.58788 8.02001 8.10546 8.02001 8.78905V13.125H5.32471V4.36523H7.93212V5.5664H7.96142C8.15673 5.17578 8.46923 4.85351 8.89892 4.59961C9.36767 4.28711 9.91454 4.13086 10.5395 4.13086C11.8091 4.13086 12.6977 4.53125 13.2055 5.33203C13.5962 5.97656 13.7915 6.97265 13.7915 8.3203V13.125Z"
  fill="#73737D"
/>
</svg></a>
                <span class="hidden">https://www.linkedin.com/in/adrian-gheorghe-01836344/</span>
            
        
            
                
                <a href="https://medium.com/@adrian.gheorghe.dev"><svg
class="social-icon-image"
width="13"
height="11"
viewBox="0 0 13 11"
fill="none"
xmlns="http://www.w3.org/2000/svg"
>
<path
  fillRule="evenodd"
  clipRule="evenodd"
  d="M1.51041 2.69775C1.51041 2.5415 1.44965 2.40261 1.32812 2.28108L0.15625 0.874837V0.666504H3.82812L6.64061 6.86441L9.11456 0.666504H12.6041V0.874837L11.5885 1.83838C11.5017 1.90782 11.467 2.00331 11.4843 2.12483V9.20815C11.467 9.32968 11.5017 9.42516 11.5885 9.49461L12.5781 10.4581V10.6665H7.63019V10.4581L8.64581 9.46857C8.6979 9.41648 8.72828 9.37742 8.73696 9.35138C8.74564 9.32534 8.74998 9.26891 8.74998 9.18211V3.45296L5.93749 10.6404H5.54686L2.23958 3.45296V8.27065C2.22222 8.47898 2.28298 8.66128 2.42187 8.81753L3.74999 10.4321V10.6404H0V10.4321L1.32812 8.81753C1.48437 8.66128 1.54514 8.47898 1.51041 8.27065V2.69775Z"
  fill="#73737D"
/>
</svg></a>
                <span class="hidden">https://medium.com/@adrian.gheorghe.dev</span>
            
        
            
                
                <a href="https://twitter.com/adi_ghe"><svg
class="social-icon-image"
width="16"
height="13"
viewBox="0 0 16 13"
fill="none"
xmlns="http://www.w3.org/2000/svg"
{...props}
>
<path
  fillRule="evenodd"
  clipRule="evenodd"
  d="M14.0658 2.34438C14.7013 1.96349 15.1892 1.3604 15.419 0.641811C14.8244 0.994439 14.1658 1.25056 13.4648 1.3886C12.9034 0.7905 12.1036 0.416748 11.2185 0.416748C9.51888 0.416748 8.14096 1.79461 8.14096 3.49411C8.14096 3.7353 8.16822 3.97019 8.22068 4.19542C5.66301 4.06708 3.39543 2.84191 1.8776 0.980064C1.6127 1.43458 1.46094 1.96322 1.46094 2.52719C1.46094 3.59485 2.00428 4.5368 2.83003 5.08865C2.32553 5.07268 1.85104 4.93425 1.43608 4.70376C1.43586 4.71659 1.43586 4.72949 1.43586 4.74244C1.43586 6.23349 2.49666 7.47732 3.90448 7.75999C3.64622 7.83033 3.37436 7.86792 3.09366 7.86792C2.89537 7.86792 2.70257 7.84866 2.51471 7.81272C2.90629 9.03537 4.0428 9.92509 5.38945 9.94994C4.33623 10.7753 3.00928 11.2673 1.56749 11.2673C1.31911 11.2673 1.07413 11.2528 0.833374 11.2243C2.19527 12.0975 3.81291 12.6069 5.55081 12.6069C11.2113 12.6069 14.3067 7.91763 14.3067 3.85096C14.3067 3.71753 14.3037 3.5848 14.2978 3.45285C14.899 3.01896 15.4208 2.47694 15.8334 1.8598C15.2815 2.10456 14.6884 2.26998 14.0658 2.34438Z"
  fill="#73737D"
/>
</svg></a>
                <span class="hidden">https://twitter.com/adi_ghe</span>
            
        
    </div>
</div>
    </div>
</div>

    </div>

    
    <script src="/js/prism.js"></script>
</body>

</html>